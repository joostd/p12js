<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Generate PKCS#12 file</title>
<!-- the following js lib should be embedded in order for this page to run standalone -->
<script src="https://cdn.jsdelivr.net/npm/node-forge@0.7.0/dist/forge.min.js"></script>
<!--link rel="stylesheet" type="text/css" media="all" href="style.css" /-->
<style type="text/css" media="screen">
/* embedded CSS is used so page can run standalone */
body
{
  font-family: Arial, Helvetica, sans-serif;
}

legend
{
	font-weight: bold;
	color: #77f;
}

#filedrag
{
	display: none;
	font-weight: bold;
	text-align: center;
	padding: 1em 0;
	margin: 1em 0;
	border: 2px dashed #888;
	border-radius: 7px;
	cursor: default;
}
#filedrag.hover
{
	color: #aaa;
	border-color: #aaa;
	border-style: solid;
	box-shadow: inset 0 3px 4px #888;
}

#messages
{
	padding: 0 10px;
	margin: 1em 0;
	border: 1px solid #999;
}

textarea
{
  font-family: monospace;
  vertical-align: top;
}
</style>
</head>
<body>

<h1>Generate PKCS #12 file</h1>

This page will:
<ol>
  <li>
    generate a 2048-bit RSA key pair <em>in your browser</em> (i.e. the private key is never sent to the server)
  </li>
  <li>
    generate a PKCS#10 Certificate Signing Request (CSR) for the newly generated RSA public key
  </li>
  <li>
    copy the CSR to your clipboard, so you can submit it to a Certification Authority (CA)
  </li>
  <li>
    let you load a PKCS#7 file with your X.509 certificate (and intermediate CA certificates)
  </li>
  <li>
    generate a PKCS#12 file containing your (password protected) private key and all certificates for you to import on your system.
  </li>
</ol>

<form id="upload">

<fieldset>
  <legend>PKCS#10 CSR</legend>
  <div>
    <label for="csr">Generated PKCS#10:</label>
    <textarea id="csr" wrap="off" cols="64" rows="15">
        Generating...
    </textarea>
    <button type="button" onclick="copy('csr')">Copy CSR to clipboard</button>
  </div>
</fieldset>

<fieldset>
  <legend>PKCS#7 Certificates</legend>
  <input type="hidden" id="MAX_FILE_SIZE" name="MAX_FILE_SIZE" value="10000" />
  <div>
    <label for="fileselect">PKCS#7 File to load:</label>
    <input type="file" id="fileselect" name="fileselect[]" accept=".p7b,application/x-pkcs7-certificates"/>
    <div id="filedrag">or drop .p7b file here</div>
  </div>
  <div id="submitbutton">
    <button type="submit">Load PKCS#7 File</button>
  </div>
</fieldset>

<fieldset>
    <legend>PKCS#12 Export</legend>
    <div>
      <label for="p12link">Generated PKCS#12:</label>
      <a id="p12link" class="button" href="#" rel="noopener" download="my.p12"><button type="button" >Download .p12</button></a>
    </div>
    <div>
        <label for="password">Generated password:</label>
        <input type="password" id="password" readonly size="50">
        <button type="button" onclick="copy('password')">Copy password to clipboard</button>
        <input type="checkbox" onclick="showPassword()">Show Password


    </div>
    
</fieldset>

</form>

<div id="messages">
<p>Generating keys...</p>
</div>
    
<script>

let keys = null;

// check necessary browser support...
if (window.File && window.FileList && window.FileReader) { //  TODO execCommand, ES6, etc 
}

function log(msg) {
		var m = document.getElementById("messages");
		// m.innerHTML = msg + m.innerHTML;
		m.innerHTML = msg;
  }
  
function showPassword() {
  let e = document.getElementById("password"); e.type = (e.type === "password") ? "text" : "password";
}

function generatePassword(size) {
  var bytes = forge.random.getBytesSync(size)
    return forge.util.encode64(bytes).replace(/[\+\/]/g, '').replace(/=+$/,'');
}

function generateP12(pem) {
  let p7 = forge.pkcs7.messageFromPem(pem);
  // console.log(p7.certificates[0].subject.attributes)
  let password = generatePassword(32);
  document.getElementById("password").value = password;

  // generate a p12 that can be imported by Chrome/Firefox/iOS (requires the use of Triple DES instead of AES)
  var p12Asn1 = forge.pkcs12.toPkcs12Asn1(keys.privateKey, p7.certificates, password, {algorithm: '3des', generateLocalKeyId: true, friendlyName: 'key generated by p12js'});
  var p12Der = forge.asn1.toDer(p12Asn1).getBytes();
  var p12b64 = forge.util.encode64(p12Der);
  // TO DO: check that end-entity-certificate public key matches private key
  console.log(keys.publicKey)
  console.log(p7.certificates[0].publicKey);
  if( keys.publicKey != p7.certificates[0].publicKey ) {
    log("ERROR: Generated RSA key does not match public key from certificate!");
  }
  document.getElementById('p12link').href = `data:application/x-pkcs12;base64,${p12b64}`;  
  // destroy keys
  keys = null;
}

function copy(id) {
  var copyText = document.getElementById(id);
  copyText.select();
  copyText.setSelectionRange(0, 99999)
  document.execCommand("copy");
  log(`copied ${id} to clipboard`);
}

fileHover = (e) => {
  e.stopPropagation();
  e.preventDefault();
  e.target.className = (e.type == "dragover" ? "hover" : "");
}

document.getElementById("filedrag").addEventListener("dragover", fileHover, false);
document.getElementById("filedrag").addEventListener("dragleave", fileHover, false);
document.getElementById("filedrag").style.display = "block";

filesAdded = (e) => {
  fileHover(e);
  let files = e.target.files || e.dataTransfer.files;
  if( files.length > 1 ) {
    log( `#files: ${files.length}`);
  }
  for (let i = 0, f; f = files[i]; i++) {
    log( `processing file: ${f.name}`);
    let reader = new FileReader();
    reader.onload = (e) => generateP12(e.target.result);
    reader.readAsText(f);
  };
}
document.getElementById("fileselect").addEventListener("change", filesAdded, false);
document.getElementById("filedrag").addEventListener("drop", filesAdded, false);

document.getElementById("submitbutton").style.display = "none";

keys = forge.pki.rsa.generateKeyPair(2048);
console.log(keys.privateKey);

csr = forge.pki.createCertificationRequest();
csr.publicKey = keys.publicKey;
csr.sign(keys.privateKey, forge.md.sha256.create());
document.getElementById("csr").value = forge.pki.certificationRequestToPem(csr);
log(`generated key pair and CSR`);
</script>

</body>
</html>
